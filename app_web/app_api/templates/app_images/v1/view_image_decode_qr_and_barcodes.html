{% extends "base_api_apps_view.html" %}
{% load static %}


{% block html_form_logic %}
  <p class="text-center text-muted">
    ðŸ“Œ This section is not open-source â€” it's based on a purchased theme whose HTML markup remains proprietary and cannot be shared under open-source terms.
  </p>
{% endblock %}

{% block scripts %}
<script>
let divResponse;
let spinner;
let divError;
let errorMessage;

document.addEventListener('DOMContentLoaded', () => {
    divResponse = document.getElementById('div-response');
    divResponse.style.display = 'none';

    spinner = document.getElementById('spinner');
    spinner.style.display = 'none';

    divError = document.getElementById('div-error');
    divError.style.display = 'none';
});

document.getElementById('dicom-form').addEventListener('submit', function (e) {
    e.preventDefault();
    divError.style.display = 'none'; // Hide error message for new requests
    divResponse.style.display = 'none'; // Hide previous responses
    divResponse.innerHTML = ''; // Clear previous content

    const fileInput = document.getElementById('file');

    let totalSize = 0;

    if (fileInput.files.length === 0) {
        alert('Please select an image file to process.');
        return;
    }

    totalSize += fileInput.files[0].size;

    if (totalSize > {{ api.other_info.file_size_mb }} * 1024 * 1024) {
        alert('The total size of the uploaded files must not exceed {{ api.other_info.file_size_mb }} MB.');
        return;
    }

    spinner.style.display = 'block';

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    fetch('{{ fast_api_path_full_path }}', {
        method: 'POST',
        headers: {
            "Authorization": "Bearer {{ token }}"
        },
        body: formData
    })
    .then(response => {
        if (response.status === 200) {
            return response.json().then(data => {
                spinner.style.display = 'none';

                if (data.codes && data.codes.length > 0) {
                    // Build the list of codes
                    let codesHtml = '<ul class="list-group">';

                    data.codes.forEach((code, index) => {
                        codesHtml += `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Type:</strong> ${code.type}<br>
                                    <strong>Data:</strong> <span id="code-data-${index}">${code.data}</span>
                                </div>
                                <button class="btn btn-outline-secondary btn-sm" onclick="copyToClipboard('code-data-${index}', this)">
                                    <i class="bi bi-clipboard"></i> Copy
                                </button>
                            </li>
                        `;
                    });

                    codesHtml += '</ul>';

                    divResponse.innerHTML = codesHtml;
                    divResponse.style.display = 'block';
                } else {
                    errorMessage = document.getElementById('error-message');
                    errorMessage.textContent = "No codes found in the image.";
                    divError.style.display = 'block';
                }
            });
        } else {
            return response.json().then(data => {
                errorMessage = document.getElementById('error-message');
                errorMessage.textContent = data.detail || "An unknown error occurred.";
                spinner.style.display = 'none';
                divError.style.display = 'block';
            });
        }
    })
    .catch(error => {
        errorMessage = document.getElementById('error-message');
        errorMessage.textContent = "Please try again later.";
        spinner.style.display = 'none';
        divError.style.display = 'block';
        console.error('Fetch error:', error);
    });
});

function copyToClipboard(elementId, button) {
    const codeDataElement = document.getElementById(elementId);
    const codeData = codeDataElement.textContent;

    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(codeData).then(() => {
            showCopySuccess(button);
        }).catch(err => {
            console.error('Could not copy text: ', err);
        });
    } else {
        const textarea = document.createElement('textarea');
        textarea.value = codeData;
        textarea.style.position = 'fixed';
        textarea.style.top = 0;
        textarea.style.left = 0;
        textarea.style.opacity = 0;
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                // Success feedback
                showCopySuccess(button);
            } else {
                console.error('Fallback: Copy command was unsuccessful');
            }
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
        }

        document.body.removeChild(textarea);
    }
}

function showCopySuccess(button) {
    button.innerHTML = '<i class="bi bi-check-lg"></i> Copied!';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-success');

    setTimeout(() => {
        button.innerHTML = '<i class="bi bi-clipboard"></i> Copy';
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    }, 2000);
}

</script>
{% endblock %}
